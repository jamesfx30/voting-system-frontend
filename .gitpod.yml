# .gitpod.yml
# This file configures your GitPod workspace for the voting-system-frontend project.

tasks:
  - name: Frontend Setup and Start
    before: |
      echo "Updating vite.config.js with current GitPod hostname..."
      CURRENT_GITPOD_HOSTNAME=$(echo "$GITPOD_WORKSPACE_URL" | sed -E 's/https?:\/\///' | cut -d'/' -f1)
      sed -i "s/\\[GITPOD_HOSTNAME\\]/${CURRENT_GITPOD_HOSTNAME}/g" vite.config.js
      echo "vite.config.js updated successfully with $CURRENT_GITPOD_HOSTNAME"
      
      echo "Installing frontend dependencies..."
      npm install --prefix .

    command: |
      echo "Starting frontend development server..."
      npm run dev

  - name: Backend Setup and Start
    init: |
      cd backend
      echo "Installing backend dependencies..."
      npm install
      
      echo "Creating/Updating backend .env file..."
      # Write the content to your .env file using the 'cat' here-document
      # Ensure these values match your local .env and Paystack keys
      cat << EOF > .env
      JWT_SECRET=nryy6cZQ0d5hZrotr+fyMKvwJQPmpA5eSMSCjBmru+4=

      # Backend Environment Variables for GitPod Development
      PAYSTACK_PUBLIC_KEY=pk_test_8e6be318166adbe1c22ac7c24cf22f7c174155fa
      PAYSTACK_SECRET_KEY=sk_test_5bd1d6ac0b27c299c0403d05500cb7b7b3bf56fb2

      # PostgreSQL Database Configuration
      PG_USER=postgres
      PG_HOST=localhost
      PG_DATABASE=postgres
      PG_PASSWORD=jamesfx30
      PG_PORT=5432
      EOF
      echo "Backend .env file configured."

    command: |
      cd backend
      echo "Starting backend server..."
      npm start

# Define services needed for the workspace.
# This configures a PostgreSQL database.
services:
  database:
    # Use the official PostgreSQL Docker image. Version 13 is a good stable choice.
    image: postgres:13
    # Environment variables for the PostgreSQL container itself.
    # These MUST match the PG_USER, PG_PASSWORD, PG_DATABASE from your .env file
    # for your Node.js backend to connect successfully.
    env:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: jamesfx30 # Your actual PostgreSQL password from .env
      POSTGRES_DB: postgres
    # Removed: 'ports: - 5432' from here, as it was causing the "additional properties" error.
    # GitPod will automatically expose this via the top-level 'ports' section if needed.

# List of ports to expose to the browser and their default behavior.
# Port 5173 for frontend, 5000 for backend.
ports:
  - port: 5173
    onOpen: open-browser # Automatically opens frontend in a new browser tab
  - port: 5000
    onOpen: open-browser # Automatically opens backend in a new browser tab
  - port: 5432 # Still declare the PostgreSQL port at the top-level for GitPod to handle
    onOpen: ignore # We don't need to open the database port in the browser directly
